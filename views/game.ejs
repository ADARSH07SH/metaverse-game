<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />

    <title>Game Overlay</title>
    <!-- CSS files -->
    <link rel="stylesheet" href="/css/game.css" />
    <link rel="stylesheet" href="/css/video.css" />
    <link rel="stylesheet" href="/css/mobile.css" />
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.7.2/css/all.min.css"
      integrity="sha512-Evv84Mr4kqVGRNSgIGL/F/aIDqQb7xQ2vcrdIwxfjThSH8CSR7PBEakCr51Ck+w+/U6swU2Im1vVX0SVk9ABhg=="
      crossorigin="anonymous"
      referrerpolicy="no-referrer"
    />

    <!-- Phaser and related plugins -->
    <script src="https://cdn.jsdelivr.net/npm/phaser@3/dist/phaser.min.js"></script>
    <script src="https://raw.githubusercontent.com/rexrainbow/phaser3-rex-notes/master/dist/rexvirtualjoystickplugin.min.js"></script>
    
    <!-- Load Mediasoup Client UMD Build from jsDelivr -->
    <script src="https://cdn.jsdelivr.net/npm/mediasoup-client/umd/mediasoupClient.min.js"></script>
    <script>
      console.log("window.mediasoupClient:", window.mediasoupClient);
      // You should see an object with a Device property.
    </script>
    
    <!-- Socket.io -->
    <script src="/socket.io/socket.io.js"></script>

    <!-- Global socket initialization -->
    <script>
      const socket = io();
      console.log("Socket initialized:", socket);
    </script>
  </head>
  <body>
    <div id="game-container"></div>
    <div class="mobileMain"></div>

   <div id="conferenceWindow" class="conference-window" style="display: none;">
  <div class="conference-header">
    <h2>Conference Meeting - <%= userId %></h2>
  </div>
  <div class="video-grid" id="videoGrid">
  <div id="remote-videos"></div>
  <div class="local-video-container">
    <video id="local-video" autoplay playsinline muted></video>
    <div class="participant-name">You</div>
    <div id="local-avatar" class="video-avatar"></div>
  </div>
</div>
  <button id="exitConferenceBtn">Exit Conference</button>
</div>

    <!-- Chatbox and Players List -->
    <div class="chatbox">
      <div class="chat">
        <input type="text" id="player-chat" name="playerChat" />
        <button type="submit" class="player-chat-submit">Send</button>
      </div>
      <div id="chat-messages"></div>
    </div>

    <div class="players-list hidden">
      <h3>LIVE PEOPLE</h3>
      <ul id="players-ul"></ul>
    </div>

    <div id="version"></div>

    <!-- Hidden gamedata element for passing room and user data -->
    <div id="gamedata" data-room-id="<%= roomId %>" data-user-id="<%= userId %>"></div>

    <!-- Hidden Button for Game.js if needed -->
    <button id="showButton" style="display: none"></button>

    <!-- Footer -->
    <footer>
      <div class="acc">
        <div class="myinfo">
          <h4 id="timeDisplay"></h4>
          <h4>| <%= userId %></h4>
        </div>
        <div class="accbutton">
          <div class="microphone">
            <i class="fa-solid fa-microphone"></i>
            <i class="fa-solid fa-microphone-slash"></i>
          </div>
          <div class="videobtn">
            <i class="fa-solid fa-video"></i>
            <i class="fa-solid fa-video-slash"></i>
          </div>
          <div class="reaction">
            <i class="fa-regular fa-hand" id="reaction-icon"></i>
            <div class="emoji-bar">
              <span class="emoji" data-emoji="‚úã">‚úã</span>
              <span class="emoji" data-emoji="‚ù§Ô∏è">‚ù§Ô∏è</span>
              <span class="emoji" data-emoji="üòÇ">üòÇ</span>
              <span class="emoji" data-emoji="üò≠">üò≠</span>
              <span class="emoji" data-emoji="ü§ù">ü§ù</span>
              <span class="emoji" data-emoji="üôè">üôè</span>
            </div>
          </div>
          <div class="endcall">
            <a id="callEndLink">
              <i class="fa-solid fa-phone fa-rotate-by" style="--fa-rotate-angle: 135deg"></i>
            </a>
          </div>
        </div>
        <div class="right-controls">
          <div class="chat">
            <i class="fa-regular fa-message"></i>
          </div>
          <div class="gamepad">
            <i class="fa-solid fa-gamepad"></i>
          </div>
          <div class="info">
            <i class="fa-solid fa-expand"></i>
          </div>
          <div class="people">
            <i class="fa-solid fa-users"></i>
          </div>
          <div class="othercontrols">
            <i class="fa-solid fa-ellipsis-vertical"></i>
          </div>
        </div>
      </div>
    </footer>

    <!-- Custom Scripts: Load your custom scripts after libraries -->
    <script src="/js/game-socket.js"></script>
    <script src="/js/conference.js"></script>
    <script src="/js/mobile.js"></script>
    <script src="/js/game.js"></script>
    <script src="/js/robot.js"></script>
   <!-- Add this to your HTML if not already included -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/howler/2.2.3/howler.min.js"></script>


    <!-- Inline global variables -->
    <script>
     let roomId = "<%= roomId %>";
      let userId = "<%= userId %>";
      let spriteNum = "<%= sprite %>";

      console.log("Player name:", userId);
      console.log("Joined room:", roomId);

      socket.emit("player position");
      socket.on("connect", () => {
        console.log("Socket ID:", socket.id);
      });
      socket.on("message", (data) => {
        console.log("Message from server:", data);
      });

      function updateTime() {
        const now = new Date();
        const hours = now.getHours().toString().padStart(2, "0");
        const minutes = now.getMinutes().toString().padStart(2, "0");
        document.getElementById("timeDisplay").innerText = `${hours}:${minutes}`;
      }
      updateTime();
      setInterval(updateTime, 1000);

      document.addEventListener("DOMContentLoaded", function () {
        const micButton = document.querySelector(".microphone");
        const videoButton = document.querySelector(".videobtn");
        const endcall = document.querySelector(".endcall");
        endcall.addEventListener("click", function () {
          closeGame();
        });
       
      });

      const playersList = document.querySelector(".players-list");
      const playersUl = document.getElementById("players-ul");
      const people = document.querySelector(".people");

      people.addEventListener("click", async function () {
        playersList.classList.toggle("hidden");
        if (!playersList.classList.contains("hidden")) {
          await fetchActivePlayers();
        }
      });

      async function fetchActivePlayers() {
        try {
          const response = await fetch(`/api/get-players?roomId=${roomId}`);
          const players = await response.json();
          playersUl.innerHTML = "";
          players
            .filter(player => player.active === 1)
            .forEach(player => {
              const li = document.createElement("li");
              li.textContent = player.userName;
              li.classList.add("active-player");
              playersUl.appendChild(li);
            });
            console.log(players);
        } catch (error) {
          console.error("Error fetching players:", error);
        }
      }

      document.querySelector(".chat i").addEventListener("click", function () {
        document.querySelector(".chatbox").classList.toggle("hidden");
      });

      document.querySelector(".gamepad i").addEventListener("click", function () {
        document.getElementById("showButton").click();
      });

      document.addEventListener("DOMContentLoaded", function () {
        document.getElementById("callEndLink").href = `/joinroom?userName=${encodeURIComponent(userId)}`;
      });

      window.addEventListener("beforeunload", () => {
        socket.emit("main-disconnect");
      });

      const mobile = document.querySelector(".info");

mobile.addEventListener("click", () => {
    mobileMain.classList.toggle("active");
});


      // Attach event listeners to emoji buttons
      document.addEventListener("DOMContentLoaded", function () {
        const emojis = document.querySelectorAll(".emoji");
        emojis.forEach((emojiEl) => {
          emojiEl.addEventListener("click", () => {
            const selectedEmoji = emojiEl.getAttribute("data-emoji");
            socket.emit("player-chat", {
              roomId,
              socketId: socket.id,
              message: `${userId} reacted: ${selectedEmoji}`,
              userId,
            });
          });
        });
      });
    
    </script>
  </body>
</html>
